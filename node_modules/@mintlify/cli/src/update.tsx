import { SpinnerLog, SuccessLog, ErrorLog, addLog, clearLogs } from '@mintlify/previewing';

import { execAsync, getLatestCliVersion, getVersions, detectPackageManager } from './helpers.js';

export const update = async ({ packageName }: { packageName: string }) => {
  addLog(<SpinnerLog message="updating..." />);
  const { cli: existingCliVersion } = getVersions();
  const latestCliVersion = getLatestCliVersion(packageName);
  const isUpToDate =
    existingCliVersion && latestCliVersion && latestCliVersion.trim() === existingCliVersion.trim();

  if (isUpToDate) {
    addLog(<SuccessLog message="already up to date" />);
    return;
  }

  if (existingCliVersion && latestCliVersion.trim() !== existingCliVersion.trim()) {
    try {
      clearLogs();
      addLog(<SpinnerLog message={`updating ${packageName} package...`} />);
      const packageManager = await detectPackageManager({ packageName });
      if (packageManager === 'pnpm') {
        await execAsync(`pnpm install -g ${packageName}@latest --silent`);
      } else {
        await execAsync(`npm install -g ${packageName}@latest --silent`);
      }
    } catch (err) {
      addLog(<ErrorLog message={`failed to update ${packageName}@latest`} />);
      return;
    }
  }

  clearLogs();
  addLog(
    <SuccessLog message={`updated ${packageName} to the latest version: ${latestCliVersion}`} />
  );
};
