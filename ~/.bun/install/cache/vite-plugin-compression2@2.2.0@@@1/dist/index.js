"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var e,t,r=require("@rollup/pluginutils"),i=require("fs"),n=require("node:fs/promises"),o=require("os"),s=require("path"),a=require("tar-mini"),l=require("util"),u=require("zlib"),c={exports:{}},p=(e=function(){if(t)return c.exports;t=1;let e,r,i,{defineProperty:n,setPrototypeOf:o,create:s,keys:a}=Object,{round:l,max:u}=Math,p=e=>{let t=/([a-f\d]{3,6})/i.exec(e)?.[1],r=t?.length,i=parseInt(6^r?3^r?"0":t[0]+t[0]+t[1]+t[1]+t[2]+t[2]:t,16);return[i>>16&255,i>>8&255,255&i]},d=(e,t,r)=>e^t||t^r?16+36*l(e/51)+6*l(t/51)+l(r/51):8>e?16:e>248?231:l(24*(e-8)/247)+232,f=e=>{let t,r,i,n,o;return 8>e?30+e:16>e?e-8+90:(232>e?(o=(e-=16)%36,t=(e/36|0)/5,r=(o/6|0)/5,i=o%6/5):t=r=i=(10*(e-232)+8)/255,(n=2*u(t,r,i))?30+(l(i)<<2|l(r)<<1|l(t))+(2^n?0:60):30)},h=(()=>{let t,i,n,o=e=>u.some(t=>e.test(t)),s=globalThis,l=s.process??{},u=l.argv??[],c=l.env??{},p=-1;try{e=","+a(c).join(",")}catch(e){c={},p=0}let d="FORCE_COLOR",f={false:0,0:0,1:1,2:2,3:3}[c[d]]??-1,h=d in c&&f||o(/^--color=?(true|always)?$/);return h&&(p=f),~p||(t=c,i=!!c.PM2_HOME||c.NEXT_RUNTIME?.includes("edge")||!!l.stdout?.isTTY,n="win32"===l.platform,r=t.TERM,p=({"24bit":3,truecolor:3,ansi256:2,ansi:1})[t.COLORTERM]||(t.CI?/,GITHUB/.test(e)?3:1:i&&"dumb"!==r?n?3:/-256/.test(r)?2:1:0)),!f||c.NO_COLOR||o(/^--(no-color|color=(false|never))$/)?0:s.window?.chrome||h&&!p?3:p})(),m={open:"",close:""},g={},w=({p:e},{open:t,close:r})=>{let n=(e,...i)=>{if(!e){if(t&&t===r)return t;if((e??"")==="")return""}let o,s=e.raw?String.raw({raw:e},...i):""+e,a=n.p,l=a.o,u=a.c;if(s.includes("\x1b"))for(;a;a=a.p){let{open:e,close:t}=a,r=t.length,i="",n=0;if(r)for(;~(o=s.indexOf(t,n));n=o+r)i+=s.slice(n,o)+e;s=i+s.slice(n)}return l+(s.includes("\n")?s.replace(/(\r?\n)/g,u+"$1"+l):s)+u},s=t,a=r;return e&&(s=e.o+t,a=r+e.c),o(n,i),n.p={open:t,close:r,o:s,c:a,p:e},n.open=s,n.close=a,n},y=function(e=h){let t={Ansis:y,isSupported:()=>r,strip:e=>e.replace(/[Â›][[()#;?]*(?:[0-9]{1,4}(?:;[0-9]{0,4})*)?[0-9A-ORZcf-nqry=><]/g,""),extend(e){for(let t in e){let r=e[t],i=(typeof r)[0],o="s"===i?v(...p(r)):r;g[t]="f"===i?{get(){return(...e)=>w(this,r(...e))}}:{get(){let e=w(this,o);return n(this,t,{value:e}),e}}}return o(t,i=s({},g)),t}},r=e>0,a=(e,t)=>r?{open:`[${e}m`,close:`[${t}m`}:m,l=e=>t=>e(...p(t)),u=(e,t)=>(r,i,n)=>a(`${e}8;2;${r};${i};${n}`,t),c=(e,t)=>(r,i,n)=>a(f(d(r,i,n))+e,t),b=e=>(t,r,i)=>e(d(t,r,i)),v=u(3,39),O=u(4,49),E=e=>a("38;5;"+e,39),j=e=>a("48;5;"+e,49);2===e?(v=b(E),O=b(j)):1===e&&(v=c(0,39),O=c(10,49),E=e=>a(f(e),39),j=e=>a(f(e)+10,49));let x,P={fg:E,bg:j,rgb:v,bgRgb:O,hex:l(v),bgHex:l(O),visible:m,reset:a(0,0),bold:a(1,22),dim:a(2,22),italic:a(3,23),underline:a(4,24),inverse:a(7,27),hidden:a(8,28),strikethrough:a(9,29)},C="Bright";return"black,red,green,yellow,blue,magenta,cyan,white,gray".split(",").map((e,t)=>{x="bg"+e[0].toUpperCase()+e.slice(1),8>t?(P[e+C]=a(90+t,39),P[x+C]=a(100+t,49)):t=60,P[e]=a(30+t,39),P[x]=a(40+t,49)}),t.extend(P)},b=new y;return c.exports=b,b.default=b,c.exports}())&&e.__esModule&&Object.prototype.hasOwnProperty.call(e,"default")?e.default:e;const{Ansis:d,fg:f,bg:h,rgb:m,bgRgb:g,hex:w,bgHex:y,reset:b,inverse:v,hidden:O,visible:E,bold:j,dim:x,italic:P,underline:C,strikethrough:R,black:$,red:q,green:z,yellow:_,blue:S,magenta:T,cyan:A,white:M,gray:k,redBright:I,greenBright:B,yellowBright:F,blueBright:N,magentaBright:D,cyanBright:L,whiteBright:U,bgBlack:Z,bgRed:H,bgGreen:Y,bgYellow:Q,bgBlue:X,bgMagenta:G,bgCyan:W,bgWhite:J,bgGray:K,bgRedBright:V,bgGreenBright:ee,bgYellowBright:et,bgBlueBright:er,bgMagentaBright:ei,bgCyanBright:en,bgWhiteBright:eo}=p;function es(e){return e.length}function ea(e,t,r){let i="function"==typeof t?t(e,r):t,{dir:n,base:o}=s.parse(e);return i.replace(/\[path\]/,n?n+"/":"").replace(/\[base\]/,o)}function el(e){return/^\\\\\?\\/.test(e)?e:e.replace(/\\/g,"/")}async function eu(e){let t=await Promise.all((await n.readdir(e)).map(t=>s.join(e,t))),r=0,i=[];for(;r!==es(t);){let e=t[r],o=await n.stat(e);if(o.isDirectory()){let r=await n.readdir(e);t.push(...r.map(t=>s.join(e,t)))}o.isFile()&&i.push(e),r++}return i}const ec=new TextEncoder;function ep(e){return"string"==typeof e?ec.encode(e):e}function ed(){}function ef(e){return"gz"===e?"gzip":"brotli"===e||"br"===e?"brotliCompress":"zstd"===e?"zstandard":e}async function eh(e,t,r){try{return await t(e,r)}catch(e){return Promise.reject(e)}}const em={gzip:{level:u.constants.Z_BEST_COMPRESSION},brotliCompress:{params:{[u.constants.BROTLI_PARAM_QUALITY]:u.constants.BROTLI_MAX_QUALITY}},deflate:{level:u.constants.Z_BEST_COMPRESSION},deflateRaw:{level:u.constants.Z_BEST_COMPRESSION},zstandard:{}};function eg(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}class ew{enqueue(e){this.queue.push(e),this.run()}async run(){for(;this.running<this.maxConcurrent&&this.queue.length;){let e=this.queue.shift();this.running++;try{await e()}catch(e){this.errors.push(e)}finally{this.running--,this.run()}}}async wait(){for(;this.running;)await new Promise(e=>setTimeout(e,0));if(es(this.errors))throw AggregateError(this.errors,"task failed")}constructor(e){eg(this,"maxConcurrent",void 0),eg(this,"queue",void 0),eg(this,"running",void 0),eg(this,"errors",void 0),this.maxConcurrent=e,this.queue=[],this.errors=[],this.running=0}}const ey="vite-plugin-compression",eb=(()=>{let e=o.cpus()||{length:1};return 1===e.length?10:Math.max(1,e.length-1)})();function ev(e){var t;let r=new Set,i=(e,t)=>el(s.resolve(e,t));return(null==(t=e.build.rollupOptions)?void 0:t.output)?(Array.isArray(e.build.rollupOptions.output)?e.build.rollupOptions.output:[e.build.rollupOptions.output]).forEach(t=>{("object"!=typeof t||es(Object.keys(t)))&&r.add(i(e.root,t.dir||e.build.outDir))}):r.add(i(e.root,e.build.outDir)),r}async function eO(e,t){let r=!("copyPublicDir"in e.build)||e.build.copyPublicDir;if(e.publicDir&&r&&i.existsSync(e.publicDir)){let r=await eu(e.publicDir),i=s.join(e.root,s.relative(e.root,e.publicDir));r.forEach(e=>{t(el(s.relative(i,e)),e)})}}function eE(e,t){if("AggregateError"!==e.name||!("errors"in e))return e;let r=e.errors.length,i=e.errors.map((e,t)=>{let r=e.message||"Unknown error";return`[${t+1}] ${r}`}),n=e.errors.map((e,t)=>{let r=e.stack||e.message||"No stack trace available";return`--- Error ${t+1} ---
${r}`}),o=[`Compression failed in ${t} with ${r} error(s):`,"",...i].join("\n"),s=Error(o);return s.name="CompressionError",s.stack=[`CompressionError: ${o}`,"","Combined stack traces:",...n].join("\n"),s.cause=e.errors,s}function ej(e={}){let t,{include:i=/\.(html|xml|css|json|js|mjs|svg|yaml|yml|toml)$/,exclude:o,threshold:a=0,algorithms:c=["gzip","brotliCompress"],filename:d,deleteOriginalAssets:f=!1,skipIfLargerOrEqual:h=!0}=e,m=[];c.forEach(e=>{"string"==typeof e?m.push(ex(e)):"object"==typeof e&&Array.isArray(e)&&m.push(e)});let g=r.createFilter(i,o),w=[],y=[],{msgs:b,cleanup:v}=function(){let e=[],t=process.stdout.write.bind(process.stdout);return process.stdout.write=function(...r){let[i]=r,n="string"==typeof i?i:i.toString();return n.includes("built in")?(e.push(n),!1):t.apply(this,r)},{cleanup:()=>process.stdout.write=t,msgs:e}}(),O=process.cwd(),E=m.map(([e,t])=>({algorithm:e,algorithmFunction:"string"==typeof e?function(e){let t=ef(e);if("zstandard"===t){let[e,t]=process.versions.node.split(".").map(e=>+e);if(!(e>23||23===e&&t>=8||22===e&&t>=15))throw Error(`Node.js ${process.versions.node} does not support zstd compression. Requires Node.js >= 22.15.0 or >= 23.8.0`);if(!u.zstdCompress)throw Error("zstd compression is not available in this Node.js build");return{algorithm:l.promisify(u.zstdCompress)}}let r=t in u?t:"gzip";return{algorithm:l.promisify(u[r])}}(e).algorithm:e,options:t,filename:null!=d?d:"brotliCompress"===e?"[path][base].br":"zstandard"===e?"[path][base].zst":"[path][base].gz"})),j=new ew(eb),x=async function(e,t){for(let e in t){if(!g(e))continue;let r=t[e],i=ep("asset"===r.type?r.source:r.code),n=es(i);n<a||j.enqueue(async()=>{for(let r=0;r<E.length;r++){let o=E[r],s=r===E.length-1,a=ea(e,o.filename,{options:o.options,algorithm:o.algorithm}),l=await eh(i,o.algorithmFunction,o.options);if(h&&es(l)>=n)return;s&&(f||e===a)&&Reflect.deleteProperty(t,e),this.emitFile({type:"asset",fileName:a,source:l})}})}await j.wait().catch(e=>{this.error(eE(e,"bundle compression"))})},P={resolve:ed},C={staticOutputs:new Set,done:new Promise(e=>{P.resolve=e})},R=new Intl.NumberFormat("en",{maximumFractionDigits:2,minimumFractionDigits:2}),$=e=>`${R.format(e/1e3)} kB`;return{name:ey,apply:"build",enforce:"post",api:C,async configResolved(e){y.push(...ev(e)),await eO(e,e=>{w.push(e)});let r=e.plugins.find(e=>"vite:build-import-analysis"===e.name);if(!r)throw Error("[vite-plugin-compression] Can't be work in versions lower than vite at 2.0.0");let i=r.generateBundle;if("object"==typeof i&&i.handler){let e=i.handler;i.handler=async function(...t){await e.apply(this,t),await x.apply(this,t)}}"function"==typeof i&&(r.generateBundle=async function(...e){await i.apply(this,e),await x.apply(this,e)}),t=e.logger,O=e.root},async closeBundle(){let e=[],r=async(t,r,i)=>{let o=await n.readFile(t);for(let a=0;a<E.length;a++){let l=E[a],u=a===E.length-1,c=await eh(o,l.algorithmFunction,l.options);if(h&&es(c)>=es(o)){C.staticOutputs.has(r)||C.staticOutputs.add(r);return}let p=ea(r,l.filename,{options:l.options,algorithm:l.algorithm});C.staticOutputs.has(p)||C.staticOutputs.add(p);let d=s.join(i,p);u&&f&&d!==t&&await n.rm(t,{recursive:!0,force:!0}),await n.writeFile(d,c),e.push({dest:s.relative(O,i)+"/",file:p,size:es(c)})}},i=async(e,t)=>{let i=s.join(e,t);if(!g(i)&&!C.staticOutputs.has(t))return void C.staticOutputs.add(t);let{size:o}=await n.stat(i);if(o<a){C.staticOutputs.has(t)||C.staticOutputs.add(t);return}await r(i,t,e)};for(let e of y)for(let t of w)j.enqueue(()=>i(e,t));if(await j.wait().catch(e=>e),P.resolve(),v(),t){let r=e.reduce((e,t)=>Math.max(e,(t.dest+t.file).length),0);for(let{dest:i,file:n,size:o}of e){let e=n.padEnd(r);t.info(p.dim(i)+p.green(e)+p.bold(p.dim($(o))))}}for(let e of b)console.info(e)}}}function ex(e,t){if("string"==typeof e){let r=ef(e);if(r in em){let e={...em[r]};return t&&Object.assign(e,t),[r,e]}throw Error(`[vite-plugin-compression] Unsupported algorithm: ${e}`)}return[e,t||{}]}ej.getPluginAPI=e=>{var t;return null==(t=e.find(e=>e.name===ey))?void 0:t.api},exports.compression=ej,exports.default=ej,exports.defineAlgorithm=ex,exports.tarball=function(e={}){let t,{dest:r}=e,o=[],l=[],u=[],c=process.cwd(),p=function(){let e=a.createPack(),t=[],r={dests:[],root:""};return{add:t=>{e.add(ep(t.content),{filename:t.filename})},setup:e=>{Object.assign(r,e),r.dests.forEach(e=>{let n=el(s.resolve(r.root,e+".tar")),o=el(s.dirname(n));el(r.root)!==o&&i.mkdirSync(o,{recursive:!0});let a=i.createWriteStream(n);t.push(a)})},done:async()=>{e.done(),await Promise.all(t.map(t=>new Promise((r,i)=>{t.on("error",i),t.on("finish",r),e.receiver.pipe(t)}))),t.length=0}}}(),d=new ew(eb);return{name:"vite-plugin-tarball",enforce:"post",async configResolved(e){l.push(...ev(e)),c=e.root,u=r?[r]:l,(t=ej.getPluginAPI(e.plugins))||await eO(e,e=>{o.push(e)}),p.setup({dests:u,root:c})},writeBundle(e,t){for(let e in t){let r=t[e];p.add({filename:e,content:"asset"===r.type?r.source:r.code})}},async closeBundle(){for(let e of(t&&await t.done,!o.length&&t&&t.staticOutputs.size&&o.push(...t.staticOutputs),l))for(let t of o)d.enqueue(async()=>{let r=s.join(e,t),i=await n.readFile(r);p.add({filename:t,content:i})});await d.wait().catch(e=>{this.error(eE(e,"tarball creation"))}),await p.done()}}};
